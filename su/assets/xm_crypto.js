define(["xm/elliptic","xm/sha256","xm/aes-js"],function(e,t,r){function s(e){for(var t="",r=0;r<e.length;r++)t+=String.fromCharCode(e[r]);return btoa(t)}function n(e){for(var t=atob(e),r=[],s=0;s<t.length;s++)r.push(t.charCodeAt(s));return r}function i(e){var t=16-e.length%16,r=new Uint8Array(e.length+t);r.set(e,0);for(var s=0;s<t;s++)r[e.length+s]=t;return r}function o(e){var t=e.charCodeAt(e.length-1);return e.slice(0,-t)}function a(t){if(this.ec=new e.ec("secp256k1"),t&&(this.sessionId=t.session_id,this.aesKey=n(t.key),!this.isReady()))throw"Invalid serialized crypto session"}function c(e,t){var r=u[e];if(!r)throw"Unsupported crypto scheme "+e;return new r(t)}function h(e){return c(e)}function p(e){var t=JSON.parse(e);return c(t.scheme,t)}a.prototype.getExchangeRequestHeader=function(){this.kp||(this.kp=this.ec.genKeyPair());var e={type:"key_exchange",scheme:2,y:s(this.kp.getPublic().encode())};return e},a.prototype.processExchangeResponseHeader=function(e){if(2!=e.scheme)throw"Unsupported crypto scheme "+scheme;this.sessionId=e.crypto_session_id;var r=this.kp.derive(this.ec.keyFromPublic(atob(e.y)).getPublic()),s=t.create();s.update(r.toArray("be",32)),this.aesKey=s.digest()},a.prototype.isReady=function(){return!(!this.aesKey||!this.sessionId)},a.prototype.decryptResponse=function(e){var t=null;if(e.headers.forEach(function(e){"encryption"==e.type&&(t=e)}),t){var s=n(t.iv),i=new r.ModeOfOperation.cbc(this.aesKey,s),a=n(e.data),c=i.decrypt(a),h=r.utils.utf8.fromBytes(c);h=o(h),e.data=JSON.parse(h)}return e},a.prototype.encryptRequest=function(e){for(var t=[],n=0;n<16;n++)t.push(Math.floor(256*Math.random()));var o={type:"encryption",iv:s(t),crypto_session_id:this.sessionId};e.headers.push(o);var a=JSON.stringify(e.data),c=new r.ModeOfOperation.cbc(this.aesKey,t),h=r.utils.utf8.toBytes(a),p=i(h),u=c.encrypt(p);return e.data=s(u),e},a.prototype.serialize=function(){var e={scheme:2,session_id:this.sessionId,key:s(this.aesKey)};return JSON.stringify(e)};var u={2:a};return{createCryptoSession:h,loadCryptoSession:p}});