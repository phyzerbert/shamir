define(["xm/jscookie","xm/controlFlow","xm/xm_crypto"],function(e,t,n){function r(){return"2.18.3"}function o(e){var t=this;e.forEach(function(e){t.addValue(e)})}function i(){return JSON.stringify(Object.keys(ht).map(function(e){return ht[e]}).filter(function(e){return xt.indexOf(e)===-1}))}function a(e){Et=e}function u(e){mt=e}function s(e){_t=e}function c(e){gt=e}function d(e){vt=e}function l(e){yt=e}function f(e){It=e}function p(e){wt=e}function h(e){Ct=e}function m(e){Rt=e}function _(e){Pt=e}function g(e){St=e}function v(e){jt=e}function y(e,t,n){if(gt[e+"."+t])return gt[e+"."+t];var r=gt[e];if(r instanceof Function&&"input"==t)return r;if(r[t])return r[t];if(!n)throw new Error("Can't locate user-input handler for method "+e+" ["+t+"]")}function w(t){var n=new o(["storage","cookies","local"]);if("undefined"!=typeof window){var r=window[t];try{r.setItem("ts:test","ok"),r.removeItem("ts:test");var i=n.storage}catch(e){console.warn("Failed to use browser storage. Resorting to cookies."),i=n.cookies}}else{var r={};i=n.local}this.setItem=function(t,o){switch(i){case n.storage:r.setItem(t,o);break;case n.cookies:r==window.localStorage?e.set(t,o,{expires:365}):e.set(t,o);break;case n.local:r[t]=o}},this.getItem=function(t){switch(i){case n.storage:return r.getItem(t);case n.cookies:return e.get(t);case n.local:return r[t]}},this.removeItem=function(t){switch(i){case n.storage:r.removeItem(t);break;case n.cookies:e.remove(t);break;case n.local:delete r[t]}},this.clear=function(){switch(i){case n.storage:r.clear();break;case n.cookies:var t=e.get();for(var o in t)t.hasOwnProperty(o)&&e.remove(o);break;case n.local:r={}}}}function I(e){At.removeItem(At.provisionalSessionKey(e))}function P(e){var t="false";try{t=At.getItem(At.provisionalSessionKey(e))}catch(e){}"true"==t&&(At.removeItem(At.provisionalSessionKey(e)),At.removeItem(At.sessionIdKey(e)),At.removeItem(At.deviceIdKey(e)))}function C(e){S(e),At.removeItem(At.deviceIdKey(e)),At.removeItem(At.sessionIdKey(e))}function R(e,t){var n=JSON.parse(At.getItem(At.pendingUserKey));if(n&&n.remember){var r=e.type?"otp"===e.type?e.type+"."+e.channels[0].type:e.type:e;bt.setItem(bt.defaultMethodKey(t),r)}}function S(e){bt.removeItem(bt.defaultMethodKey(e))}function j(e,t){e===bt.getItem(bt.defaultMethodKey(t))&&S(t)}function x(e){return e.methods.find(function(e){return e.isDefault&&!e.disabled})}function E(e,t){this.xhr=e,this.responseJSON=e&&e.responseJSON,this.statusCode=e&&e.status,this.err=t,this.xmapiError=lt.commError}function b(e){this.xhr=e,this.xmapiError=lt.commError}function A(e){if(!Kt&&Et!=pt.none){var t=At.getItem(At.cryptoSessionKey(e));if(t)try{Kt=n.loadCryptoSession(t)}catch(e){console.log("Warning: can't serialize crypto session: ",e)}}return Kt}function K(e){Kt=null,At.removeItem(At.cryptoSessionKey(e))}function q(e,t){var n=A(t);n&&(n.processExchangeResponseHeader(e),n.isReady()&&At.setItem(At.cryptoSessionKey(t),n.serialize()))}function F(e){return Et==pt.none||A(e)?null:(Kt=n.createCryptoSession(2),Kt.getExchangeRequestHeader())}function O(e,t,n){var r=t.getResponseHeader("X-TS-Dfp-Instructions");if(r&&require(["xm/tscl"],function(e){e.evaluateDfpServerInstructions(JSON.parse(r))}),e.headers)for(var o=0;o<e.headers.length;o++){var i=e.headers[o],a=qt[i.type];a&&a(i,e,t,n)}}function k(e,t,n,r,o,i){var a=F(i);a&&e.push(a)}function M(e,t,n,o){return new Promise(function(a,u){function s(e){var t=[];for(var n in e)e.hasOwnProperty(n)&&t.push(encodeURIComponent(n)+"="+encodeURIComponent(e[n]));return t.join("&")}var c=new XMLHttpRequest,d=mt+t+"?"+s(n);c.open(e,d,!0),c.setRequestHeader("X-TS-Client-Version",r()+"; "+i()),c.setRequestHeader("Content-Type","application/json"),c.onreadystatechange=function(){if(4===c.readyState)try{if(0===c.status)return u(new Ve({},{},lt.corsOrInvalidHost));var e=JSON.parse(c.responseText);a({data:e,xhr:c})}catch(e){return console.log("Error HTTP response processing: ",e),void u(new E(c,e))}},c.onerror=function(){c?!1===c.readyState&&!0===c.status&&u(new E(c)):u(new b(c))},c.send(JSON.stringify(o))})}function D(e,t,n,r,o){function i(e,t,n,r,o,a,u){if(Et==pt.full&&!A(o)&&u){var s={aid:n.aid,uid:o},c={data:"Hello Encrypted World"};return i("POST","key_exchange",s,c,o,a,!1).then(function(a){if(a.error_code)throw new E(null,a);return i(e,t,n,r,o,!1,!1)})}return new Promise(function(u,s){var c=[];if(xt.indexOf(ht.enveloped_client_communication)>-1)var d=r;else{k(c,e,t,n,r,o);var d={headers:c,data:r},l=A(o);l&&l.isReady()&&(d=l.encryptRequest(d))}M(e,t,n,d).then(function(c){var d=c.data,l=c.xhr;try{if(23==d.error_code&&a)return K(o),void i(e,t,n,r,o,!1,!0).then(u,s);O(d,l,o);var f=A(o);f&&f.isReady()&&(d=f.decryptResponse(d))}catch(e){return console.log("Error during promiseEnvelopedRequest processing: ",e),void s(new E(l,e))}u(d)})})}return i(e,t,n,r,o,!0,!0)}function U(e,t,n,r){return ee().then(function(o){var i={policy_request_id:n,params:r||{},collection_result:o},a={uid:t,aid:e};P(t);var u=At.getItem(At.deviceIdKey(t));u&&(a.did=u);var s=At.getItem(At.sessionIdKey(t));return s?a.sid=s:At.setItem(At.provisionalSessionKey(t),"true"),D("POST","authenticate",a,i,t).then(function(e){return 0==e.error_code?(console.log("Auth request ok"),At.getItem(At.sessionIdKey(t))?At.getItem(At.deviceIdKey(t))?(e.data&&e.data.assertions_complete&&I(t),Promise.resolve(e)):Promise.reject("Missing device id header from response: "+JSON.stringify(e)):Promise.reject("Missing session id header from response: "+JSON.stringify(e))):(console.log("Auth request failed"),Promise.reject(e))})})}function H(e,t,n,r,o,i){return z("register",e,t,n,r,o,null,i)}function T(e,t,n,r){return W("register",e,t,n,null,r)}function N(e,t,n,r,o,i){return z("unregister",e,t,n,r,o,null,i)}function J(e,t,n,r){return W("unregister",e,t,n,null,r)}function L(e,t,n,r,o,i){return z("config_menu",e,t,n,r,null,o,i)}function V(e,t,n,r){return W("config_menu",e,t,null,n,r)}function z(e,t,n,r,o,i,a,u){return ee().then(function(s){var c={collection_result:s,token:a,params:u||{}};i&&(c.type=i);var d={aid:t,uid:n,did:r,sid:o};return D("POST","authenticator/"+e,d,c,n)})}function W(e,t,n,r,o,i){P(n);var a=At.getItem(At.deviceIdKey(n)),u=At.getItem(At.sessionIdKey(n));return z(e,t,n,a,u,r,o,i)}function X(e,t,n,r,o,i,a,u){var s={assertion_id:o,action:i,fch:a};Object.assign(s,u);var c={aid:e,uid:t,did:n,sid:r};return D("POST","assert",c,s,t)}function $(e,t,n,r,o,i){var a=At.getItem(At.deviceIdKey(t)),u=At.getItem(At.sessionIdKey(t));return X(e,t,a,u,n,r,o,i).then(function(e){return e.data&&e.data.assertions_complete&&I(t),e.error_code?Promise.reject(new Ve(e,{},null)):e})}function B(e,t,n){return{method:e,data:t,assert:n}}function G(e,t,n,r,o,i,a,u,s,c){return X(e,t,n,r,o,i,a,B(u,c,s))}function Q(e,t,n,r,o,i,a,u){return $(e,t,n,r,o,B(i,u,a))}function Y(e,t,n,r,o,i,a,u,s){return X(e,t,n,r,o,i,a,B(u,s,null))}function Z(e,t,n,r,o,i,a){return $(e,t,n,r,o,B(i,a,null))}function ee(){return Ft?Ft:new Promise(function(e,t){require(["xm/ts_cr","xm/tscl"],function(t,n){var r=new Promise(function(e,n){t.TsCollectionResult(Ot).get(function(t){e(t)})}),o=new Promise(function(e,t){n.promiseCollection().then(function(t){e(t)})});Ft=Promise.all([r,o]).then(function(e){return Object.assign(e[0],e[1])}),e(Ft)})})}function te(){ee()}function ne(e){e.disabledClientFeatures&&(xt=e.disabledClientFeatures),e.collectionResultsPromise&&(Ft=e.collectionResultsPromise)}function re(e){Ot=e}function oe(e){kt=e}function ie(e,t,n,r,o,i){function a(e){if(!kt)throw new Error("UI did not set promise for cancel menu");return kt(e).then(function(e){return ie(e,t,n,r,o,i)})}switch(e.cancelAction){case st.Cancel:return n();case st.Retry:return r();case st.ChangeMethod:return o();case st.CancelRequested:return a(!1);case st.CancelWithChangeMethodRequested:return a(t.methods&&t.methods.length>1);default:return i()}}function ae(e,t){var n=e.startsWith("placeholder_")?Mt.placeholder:Mt[e];if(!n)throw new Error("Unknown authentication method "+e);var r=n[t];if(!r)throw new Error("Can't perform action '"+t+"' for  authentication method "+e);return r}function ue(e,t){return e.methods.find(function(e){return e.type==t})}function se(e,t,n,r,o){function i(t){var r=!1;if(t.data&&t.data.data&&t.data.data.locked&&e.methods)for(var o=0;o<e.methods.length;o++){var i=e.methods[o];i.type==n.type&&(i.locked=!0,i.disabled=!0,r=!0)}return r}var a=ae(n.type,"authenticate");return a(t,n,r).then(function(a){switch(a.error_handler_action_required){case ut.Fail:return a;case ut.RetryAction:var u=i(a);return Ee(e,t,r,u||o);case ut.RetryMethod:return se(e,t,n,r,o);default:return a}})}function ce(e,t,n,r){function o(i,a,u){function s(e){if(!It)throw new Error("UI did not set promise for confirm method fallback dialog");var t=i.getCurrentControlFlowStep();if(e.data&&e.data.data&&e.data.data.method)var n=ue(t,e.data.data.method);return It(u,a,n).then(function(e){return e===dt.Continue||"continue"===e?n&&!n.disabled?se(t,i,n,u):Ee(t,i,u,!0):o(i,a,u)})}function c(e,t,n){return e(t,u,n).then(function(e){switch(e){case ut.Fail:return t;case ut.RetryMethod:return o(i,n,u);default:return t.error_handler_action_required=e,t}})}n=n||function(e,t,n,r){return Q(t.app_id,t.user_id,n.assertion_id,"authentication",t.challenge,n.type,"authenticate",e)};var d=function(n){if(t&&(n=t(n)||n),!n.data.assertion_error_code){var r=i.getCurrentControlFlowStep();return n.data.assertions_complete&&r.options&&r.options.update_default&&R(a,i.user_id),n}if(19==n.data.assertion_error_code)return s(n);var o=y(e,"recover",!0)||Ct;return o?c(o,n,a):n},l=y(e,r||"input");return l(a,u).then(function(o){return ie(o,i.getCurrentControlFlowStep(),function(){return Promise.reject(st.Cancel)},function(){var o=ce(e,t,n,r);return o(i,a,u)},function(){return Ee(i.getCurrentControlFlowStep(),i,u,!0)},function(){return n(o,i,a,u).then(d)})})}return o}function de(e,t,n,r,o,i){var a=ce(e,t,i);return a(n,r,o)}function le(e,t,n){var r=function(e){5==e.data.assertion_error_code&&(e.data.xmapiError=lt.invalidVoice)},o=function(n){return n.sample_set_id||(n.sample_set_id=t.sample_set_id),Q(e.app_id,e.user_id,t.assertion_id,"authentication",e.challenge,t.type,"authenticate",n)};return de("voice",r,e,t,n,o)}function fe(e,t,n){var r=function(e){5==e.data.assertion_error_code&&(e.data.xmapiError=lt.invalidPassword)};return de("password",r,e,t,n)}function pe(e,t,n){function r(e){var n=t.otp_format&&t.otp_format.type?t.otp_format.type:"numeric",r="input."+n,i=function(e){return 5==e.data.assertion_error_code&&(e.data.xmapiError=lt.invalidOtp),e};return ce("otp",i,function(t,n,r,i){return t.command&&"resend"==t.command?o(e):Q(n.app_id,n.user_id,r.assertion_id,"authentication",n.challenge,r.type,"authenticate",t)},r)}function o(o){return Q(e.app_id,e.user_id,t.assertion_id,"authentication",e.challenge,t.type,"otp",o?{target_id:o}:{}).then(function(i){return i.data&&i.data.data&&i.data.data.otp_format&&(t.otp_format=i.data.data.otp_format),r(o)(e,t,n)})}if("generate"==t.state){var i=t.channels[0];if("none"===i.type)return o();if(i.targets&&Object.keys(i.targets).length>0){var a=y("otp","targetSelection");return a(t,n).then(function(r){return ie(r,e.getCurrentControlFlowStep(),function(){return Promise.reject(st.Cancel)},function(){return pe(e,t,n)},function(){return Ee(e.getCurrentControlFlowStep(),e,n,!0)},function(){return o(r)})})}return Promise.reject("No targets available for otp channel")}return"validate"==t.state?r()(e,t,n):Promise.reject("Illegal state for otp authentication: "+t.state)}function he(e,t,n){return"undefined"!=typeof t.selectable_devices?me(e,t,n):_e(e,t,n,[])}function me(e,t,n){var r=y("mobileApprove","deviceSelection");return r(t,n).then(function(r){return ie(r,e.getCurrentControlFlowStep(),function(){return Promise.reject(st.Cancel)},function(){return me(e,t,n)},function(){return Ee(e.getCurrentControlFlowStep(),e,n,!0)},function(){var o=r||[];return _e(e,t,n,o)})})}function _e(e,t,n,r){var o=function(e,t,n,o){return e.device_ids=r,Q(t.app_id,t.user_id,n.assertion_id,"authentication",t.challenge,n.type,"authenticate",e)},i=function(e){return 5==e.data.assertion_error_code&&(e.data.xmapiError=lt.invalidTotp),e},a=ce("totp",i,o);return a(e,t,n)}function ge(e,t,n,r,o,i,a){return function(u,s,c){function d(e,t){f=setInterval(function(){l(e,t)},_t)}function l(t,l){clearInterval(f),n(u,s).then(function(n){if(n.data=r(n.data),o(n.data))return void d(t,l);if(!n.data.assertion_error_code){var f=u.getCurrentControlFlowStep();return n.data.assertions_complete&&f.options&&f.options.update_default&&R(s,u.user_id),void t(n)}var p=y(e,"recover",!0)||i?Rt:Ct;p?p(n,c,s).then(function(e){e&&(n.error_handler_action_required=e,a&&a(s)),t(n)}):l(n)}).catch(function(e){l("failed to authenticate: "+JSON.stringify(e))})}var f;return new Promise(function(e,n){function r(){t(s,c).then(function(t){return ie(t,u.getCurrentControlFlowStep(),function(){clearInterval(f),n(st.Cancel)},function(){r()},function(){clearInterval(f),a&&a(s),e(Ee(u.getCurrentControlFlowStep(),u,c,!0))},function(){clearInterval(f),n("Unsupported cancel action")})})}d(e,n),r()})}}function ve(e,t,n){return"wait_for_approval"==t.state?ye(e,t,n):ge("mobileApprove",y("mobileApprove","input"),function(e,t){return Q(e.app_id,e.user_id,t.assertion_id,"authentication",e.challenge,t.type,"authenticate",{approval_id:t.approval_id})},function(e){return 5==e.assertion_error_code?e.xmapiError=lt.approvalDenied:21==e.assertion_error_code&&(e.xmapiError=lt.approvalExpired),e},function(e){return 13==e.assertion_error_code},!1,function(e){delete e.approval_id,delete e.otp,delete e.otp_code,e.state="wait_for_approval"})(e,t,n)}function ye(e,t,n){function r(r){return Q(e.app_id,e.user_id,t.assertion_id,"authentication",e.challenge,t.type,"approval",r?{device_ids:r}:{}).then(function(r){return!r.data||r.data.assertion_error_code?Promise.reject(new Ve(r,e.jsonData,lt.authActionError)):(t.approval_id=r.data.data.approval_id,t.otp=r.data.data.otp,t.otp_code=r.data.data.otp_code,t.state="wait_for_authenticate",ve(e,t,n))})}if(t.strategy.user_selection&&!t.approval_id){if(we(t.selectable_devices))return r(null);var o=y("mobileApproveSelect","input");return o(t,n).then(function(o){return ie(o,e.getCurrentControlFlowStep(),function(){return Promise.reject(st.Cancel)},function(){return ye(e,t,n)},function(){return Ee(e.getCurrentControlFlowStep(),e,n,!0)},function(){return r(o)})})}return r(null)}function we(e){return"undefined"==typeof e||0==e.length}function Ie(e,t,n){var r=ge("mobilePin",y("mobilePin","pending"),function(e,t){return Q(e.app_id,e.user_id,t.assertion_id,"authentication",e.challenge,t.type,"authenticate",{})},function(e){return 5==e.assertion_error_code&&(e.xmapiError=lt.approvalDenied),e},function(e){return 16==e.assertion_error_code},!1),o=y("mobilePin","input");return t.state&&"wait_for_execute"!=t.state?r(e,t,n):o(t,n).then(function(n){return Q(e.app_id,e.user_id,t.assertion_id,"authentication",e.challenge,t.type,"execute",n)}).then(function(){return r(e,t,n)})}function Pe(e,t,n){var r=ce("question",function(e){16==e.data.assertion_error_code&&(e.another_question=!0,e.data.assertion_error_code=0)});return r(e,t,n).then(function(r){return r.another_question?(t.question=r.data.data.question,Pe(e,t,n)):r})}function Ce(e,t,n){return t.placeholderContextData=btoa(JSON.stringify({device_id:At.getItem(At.deviceIdKey(e.user_id)),auth_type:t.type,assertion_id:t.assertion_id,challenge:e.challenge})),de(t.type,null,e,t,n)}function Re(e,t,n){return y(t.method,"register")(t,n).then(function(){return $(e.app_id,e.user_id,t.assertion_id,"registration",e.challenge,t.method,"register",null)})}function Se(e,t,n){return y(t.method,"unregister")(t,n).then(function(){return $(e.app_id,e.user_id,t.assertion_id,"unregistration",e.challenge,t.method,"unregister",null)})}function je(e,t,n){var r=function(e){5==e.data.assertion_error_code&&(e.data.xmapiError=lt.invalidPattern)};return de("pattern_centralized",r,e,t,n)}function xe(e,t,n){var r=function(e){5==e.data.assertion_error_code&&(e.data.xmapiError=lt.invalidPin)};return de("pin_centralized",r,e,t,n)}function Ee(e,t,n,r){var o=e.methods.filter(function(e){return!e.locked}),i=e.methods.filter(function(e){return!e.disabled});if(!o.length)return Promise.reject(new Ve(null,t.jsonData,lt.allAuthenticatorsLocked));if(!i.length)return Promise.reject(new Ve(null,t.jsonData,lt.noRegisteredAuthenticator));if(1==e.methods.length)return se(e,t,e.methods[0],n);if("menu"!==e.options.start_with&&!r){if("first"===e.options.start_with)return se(e,t,i[0],n);var a=x(e);if(!a){var u=0;i.forEach(function(e){e.last_used&&e.last_used>u&&(u=e.last_used,a=e),e.registration_time&&e.registration_time>u&&(u=e.registration_time,a=e)})}return se(e,t,a,n)}var s=gt.methodMenu2;return s?s(e.methods,n).then(function(r){return se(e,t,r,n,!0)}):void 0}function be(e,t,n){var r=ae(e.method,"register");return r(t,e,n)}function Ae(e,t,n,r){var o=qe(n.method,e);return o(t,n,r)}function Ke(e){return 11==e.data.assertion_error_code&&(e.data.xmapiError=lt.secretAlreadyUsed),e}function qe(e,t,n){function r(r,o,i){function a(e,n){return i.regFailureReason={xmapiError:n.data.xmapiError,xmapiErrorReplacements:n.data.xmapiErrorReplacements},e(n,i).then(function(e){switch(e){case ut.Fail:return n;case ut.RetryMethod:return Ae(t,r,o,i);default:return n.error_handler_action_required=e,n}})}n=n||function(e,t,n,r){return Z(t.app_id,t.user_id,n.assertion_id,"registration",t.challenge,n.type,e)};var u=function(n){if(t&&(n=t(n)||n),!n.data.assertion_error_code)return n;var r=y(e,"registrationRecover",!0)||Rt;return r?a(r,n,o):n},s=y(e,"registrationInput");return s(o,i).then(function(a){return ie(a,r.getCurrentControlFlowStep(),function(){return Promise.reject(st.Cancel)},function(){var a=qe(e,t,n);return a(r,o,i)},function(){},function(){return n(a,r,o,i).then(u)})})}return r}function Fe(e,t,n){var r=ge("mobilePin",y("mobilePin","registrationPending"),function(e,t){return Z(e.app_id,e.user_id,t.assertion_id,"registration",e.challenge,t.method,{action:"is_registered"})},function(e){return 5==e.assertion_error_code&&(e.xmapiError=lt.approvalDenied),e},function(e){return 16==e.assertion_error_code},!0),o=function(o){var i={action:"enroll_mobile"};return Object.assign(i,o),Z(e.app_id,e.user_id,t.assertion_id,"registration",e.challenge,t.type,i).then(function(o){return 11==o.data.assertion_error_code?Promise.reject(new Ve(o.data,e.jsonData,lt.secretAlreadyUsed)):r(e,t,n)})},i=y("mobilePin","registrationInput");return i(t,n).then(function(r){return ie(r,e.getCurrentControlFlowStep(),function(){return Promise.reject(st.Cancel)},function(){return Fe(e,t,n)},function(){},function(){return o(r)})})}function Oe(e,t,n){return Ae(Ke,e,t,n)}function ke(e,t,n){return Ae(Ke,e,t,n)}function Me(e,t,n){return Ae(Ke,e,t,n)}function De(e,t,n){function r(e){return 17==e.data.assertion_error_code&&(e.data.xmapiError=lt.notEnoughAnswers,e.data.xmapiErrorReplacements={$count:t.reg_min_questions}),e}return Ae(r,e,t,n)}function Ue(e,t,n){var r=ae(e.method,"unregister");return r(t,e,n).then(function(n){return j(e.method,t.user_id),Promise.resolve(n)})}function He(e,t,n){return $(t.app_id,t.user_id,e.assertion_id,"json_data",t.challenge,{assert:"action"}).then(function(e){var r=e.data.data.json_data;return t.jsonData=r,St&&St(r,n),Promise.resolve(e)})}function Te(e,t,n){if(!vt)throw new Error("UI did not set promise for confirmation dialog");return vt(e.title,e.text,e.continue_button_text,e.cancel_button_text,n).then(function(n){return n===dt.Continue||"continue"===n?$(t.app_id,t.user_id,e.assertion_id,"confirmation",t.challenge,{}):Promise.resolve({data:{assertion_error_code:"confirmation_error",error:"user rejected the confirmation"}})})}function Ne(e,t,n){if(!yt)throw new Error("UI did not set promise for information dialog");return yt(e.title,e.text,e.button_text,n).then(function(){return $(t.app_id,t.user_id,e.assertion_id,"information",t.challenge,{})})}function Je(e,t,n){function r(i,a){return o(e.form_id,e.app_data,i,a,n).then(function(i){var a={input:i.input};return $(t.app_id,t.user_id,e.assertion_id,"form",t.challenge,a).then(function(t){switch(t.data.assertion_error_code){case 0:return o(e.form_id,e.app_data,ft.done,t.data.data,n).then(function(e){return t});case 16:return r(ft.continue,t.data.data);case 18:return r(ft.error,t.data.data);default:return t}})})}if(!wt)throw new Error("UI did not set promises for form handling");var o=wt[e.form_id];if(!o)throw new Error("UI did not set promise for form handling for form '"+e.form_id+"'");return r(ft.show,{})}function Le(e,t,n){this.serverData=e,this.jsonData=t,this.deviceId=At.getItem(At.deviceIdKey(n)),this.sessionId=At.getItem(At.sessionIdKey(n)),Object.assign(this,this.serverData)}function Ve(e,t,n){this.serverData=e,this.jsonData=t,Object.assign(this,this.serverData),n&&(this.xmapiError=n)}function ze(e,t){var n=e.getCurrentControlFlowStep(),r=Dt[n.type];return r(n,e,t)}function We(e,t){return ze(e,t).then(function(n){return n.data.assertions_complete?new Le(n.data,e.jsonData,e.user_id):n.data.assertion_error_code?Promise.reject(new Ve(n.data,e.jsonData,n.data.xmapiError)):(e.completeCurrentControlFlowStep(),We(e,t))})}function Xe(e,t){if(4001==e.error_code){var n=e.data.rejection_data;return n&&Pt?Pt(n.title,n.text,n.button_text,n,t).then(function(t){return Promise.reject(new Ve(e.data,{},lt.authRejected))}):Promise.reject(new Ve(e.data,{},lt.authRejected))}return 4006==e.error_code?Promise.reject(new Ve(e.data,{},lt.sessionExpired)):e instanceof b?Promise.reject(new Ve({},{},lt.commError)):Promise.reject(e)}function $e(e,n,r,o,i){return U(e,n,r,o).then(function(r){var o=At.getItem(At.deviceIdKey(n)),a=At.getItem(At.sessionIdKey(n));if(r.data.control_flow){var u=new t.ControlFlowContext(e,n,r.data.control_flow,r.data.challenge,bt.getItem(bt.defaultMethodKey(n)));return We(u,i)}return r.data.assertions_complete?(r.data.deviceId=o,r.data.sessionId=a,r.data):Promise.reject(r)}).catch(function(e){return Xe(e,i)})}function Be(e,n,r,o){if(e.data.control_flow){var i=new t.ControlFlowContext(n,r,e.data.control_flow,e.data.challenge);return We(i,o)}return e.data.assertions_complete?e.data:Promise.reject(e)}function Ge(e,t,n,r,o){return Be(e,t,n,o).then(function(e){return j(r,n),Promise.resolve(e)})}function Qe(e,t,n,r,o,i,a){return H(e,t,n,r,o,i).then(function(n){return Be(n,e,t,a)}).catch(function(e){return Xe(e,a)})}function Ye(e,t,n,r,o){return T(e,t,n,r).then(function(n){return Be(n,e,t,o)}).catch(function(e){return Xe(e,o)})}function Ze(e,t,n,r,o,i,a){return N(e,t,n,r,o,i).then(function(n){return Ge(n,e,t,o,a)}).catch(function(e){return Xe(e,a)})}function et(e,t,n,r,o){return J(e,t,n,r).then(function(r){return Ge(r,e,t,n,o)}).catch(function(e){return Xe(e,o)})}function tt(e,n,r){if(e.data&&e.data.methods&&e.data.methods.length>0){var o=t.markDisabledAndDefaultMethods(e.data.methods,bt.getItem(bt.defaultMethodKey(n))),i=gt.configMenu;return i?i(o,r):Promise.reject("config menu input promise not set")}return Promise.reject("no methods found for configuration: "+JSON.stringify(e))}function nt(e,t,n,r,o,i,a){return L(e,t,n,r,o,i).then(function(e){return tt(e,t,a)}).then(function(o){return ot(o.action,e,t,n,r,o.method,i,a)}).catch(function(e){return Promise.reject(error)})}function rt(e,t,n,r,o){return V(e,t,n,r).then(function(e){return tt(e,t,o)}).then(function(n){return it(n.action,e,t,n.method,r,o)}).catch(function(e){return Promise.reject(e)})}function ot(e,t,n,r,o,i,a,u){switch(e){case ct.Register:return Qe(t,n,r,o,i,a,u);case ct.Unregister:return jt?jt(i).then(function(e){return e===dt.Continue||"continue"===e?Ze(t,n,r,o,i,a,u):Promise.resolve()}):Promise.reject("unregistration confirmation input promise not set");case ct.SetDefault:return R(i,n),Promise.resolve();default:return Promise.reject("unsupported action: "+e)}}function it(e,t,n,r,o,i){switch(e){case ct.Register:return Ye(t,n,r,o,i);case ct.Unregister:return jt?jt(r).then(function(e){return e===dt.Continue||"continue"===e?et(t,n,r,o,i):Promise.resolve()}):Promise.reject("unregistration confirmation input promise not set");case ct.SetDefault:return R(r,n),Promise.resolve();default:return Promise.reject("unsupported action: "+e)}}function at(e,t,n,r){var o={token:n,params:r||{}},i={uid:t,aid:e},a=At.getItem(At.deviceIdKey(t));return a&&(i.did=a),D("POST","logout",i,o,t).then(function(e){return 0==e.error_code?(console.log("Logout succeeded"),At.removeItem(At.sessionIdKey(t)),Promise.resolve(e)):(console.log("Logout failed"),Promise.reject(e))})}o.prototype.addValue=function(e){this[e]={name:e,toString:function(){return e}}},Array.prototype.flatMap=function(e){return Array.prototype.concat.apply([],this.map(e))};var ut=new o(["RetryMethod","RetryAction","Fail"]),st=new o(["Cancel","Retry","ChangeMethod","CancelRequested","CancelWithChangeMethodRequested"]),ct=new o(["Register","Unregister","SetDefault"]),dt=new o(["Continue","Cancel"]),lt=new o(["invalidVoice","invalidPassword","invalidPattern","invalidPin","invalidOtp","approvalDenied","approvalExpired","authRejected","authActionError","allAuthenticatorsLocked","noRegisteredAuthenticator","commError","secretAlreadyUsed","notEnoughAnswers","corsOrInvalidHost","invalidTotp","sessionExpired"]),ft=new o(["show","done","continue","error","fatal"]),pt=new o(["full","credentials","none"]),ht={headers:1,method_fallback:2,registration_flow:3,enveloped_client_communication:11,unregistration_flow:12},mt="",_t=1e3,gt={},vt=null,yt=null,wt=null,It=null,Pt=null,Ct=null,Rt=null,St=null,jt=null,xt=[],Et=pt.none,bt=new w("localStorage");bt.usersHistoryKey="ts:usersHistory",bt.defaultMethodKey=function(e){return"ts:method:default:"+e};var At=new w("sessionStorage");At.cryptoSessionKey=function(e){return"ts:cSessionId:"+e},At.deviceIdKey=function(e){return"ts:deviceId:"+e},At.sessionIdKey=function(e){return"ts:sessionId:"+e},At.provisionalSessionKey=function(e){return"ts:provisionalSession:"+e},At.pendingUserKey="ts:pendingUser";var Kt=null,qt={session_id:function(e,t,n,r){At.setItem(At.sessionIdKey(r),e.session_id)},device_id:function(e,t,n,r){At.setItem(At.deviceIdKey(r),e.device_id)},key_exchange:function(e,t,n,r){q(e,r)}},Ft=null,Ot=null,kt=null,Mt={password:{authenticate:fe,register:Me},otp:{authenticate:pe},mobile_approve:{authenticate:ve},totp:{authenticate:he},voice_server:{authenticate:le},question:{authenticate:Pe,register:De},mobile_pin:{authenticate:Ie,register:Fe},placeholder:{authenticate:Ce,register:Re,unregister:Se},pattern_centralized:{authenticate:je,register:Oe},pin_centralized:{authenticate:xe,register:ke}},Dt={authentication:Ee,json_data:He,confirmation:Te,information:Ne,form:Je,registration:be,unregistration:Ue};return{LocalStorage:bt,SessionStorage:At,AssertionErrorHandlerResponse:ut,CancelFlowActions:st,ConfigMenuActions:ct,ConfirmationActions:dt,FormHandlerEvents:ft,EncryptionMode:pt,postAuthenticateRequest:U,postAuthenticationAssertionRequest:G,postAuthenticationAssertionRequestPromise:Q,postRegistrationAssertionRequest:Y,postRegistrationAssertionRequestPromise:Z,postRegisterAuthenticatorRequestPromise:T,postUnregisterAuthenticatorRequestPromise:J,postAssertionRequest:X,postAssertionRequestPromise:$,promiseAuthenticationResult:$e,promiseRegistrationResult:Qe,promiseRegisterAuthenticatorResult:Ye,promiseConfigMenuResult:nt,promiseConfigMenuAction:rt,promiseLogout:at,setAuthenticationMethodInputPromises:c,setAuthenticationMethodFailureRecoveryPromise:h,setMethodRegistrationFailureRecoveryPromise:m,setAuthenticationRejectionInputPromise:_,setConfirmationInputPromise:d,setInformationInputPromise:l,setFormHandlerPromises:p,setConfirmMethodFallbackInputPromise:f,setJsonDataCallback:g,setUnregistrationConfirmationInputPromise:v,setCollectionResultsOptions:re,setCancelActionMenuPromise:oe,setWebloginUrl:u,setPollingIntervalMillis:s,setEncryptionMode:a,preCollect:te,deleteUserData:C,getVersion:r,__integrationTestingConfig:ne}});